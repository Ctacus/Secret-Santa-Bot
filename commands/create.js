const Discord   = require('discord.js');
const { query } = require('../mysql');
const config    = require('../json/config.json');
const methods   = require('../utils/methods');

module.exports = {
    name: 'create',
    aliases: [''],
    description: '–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ê–î–ú, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –≤—Å–µ –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è.',
    hasArgs: true,
    requirePartner: false,
    worksInDM: false,
    forceDMsOnly: false,
    modOnly: false,
    adminOnly: false,
    guildModsOnly: true,

    async execute(message, args, prefix) {
        const row = (await query(`SELECT * FROM users WHERE userId = ${message.author.id}`))[0];

        if (row.exchangeId !== 0) return message.reply('–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –ê–î–ú! –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ê–î–ú, –ø–æ–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–º–µ–Ω–∏—Ç—å –µ–≥–æ.');
        let deadline = args.join(' ');
        const embed = new Discord.MessageEmbed()
            .setTitle('__' + message.member.displayName + ' –∑–∞–ø—É—Å—Ç–∏–ª –Ω–æ–≤–æ–≥–æ –ê–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞!__')
            .setDescription('–ù–∞–∂–º–∏—Ç–µ üéÖ —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!' +
                '\n–£–±–µ—Ä–∏—Ç–µ üéÖ —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ –∫—Ä—É–≥–∞!' +
                (deadline ? '\n\n–ñ–¥—ë–º –≤—Å–µ—Ö –¥–æ ' + deadline + '!' : ''))
            // .setFooter(message.member.displayName + ' –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π ' + config.prefix + 'start') // TODO: –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö, –∫ –∫–æ–º—É –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è
            .setFooter('–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –ø—Ä–∏—ë–º –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞, –∏–Ω–∞—á–µ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞ –Ω–µ –±—É–¥–µ—Ç!')
            .setColor(config.embeds_color)

        const botMessage = await message.channel.send(embed);
        try {
            await botMessage.react('üéÖ');
        } catch (err) {
        }

        await query(`UPDATE users SET exchangeId = ${botMessage.id} WHERE userId = ${message.author.id}`);
        await addNewExchange(botMessage.id, message.author.id);
    },
}

async function addNewExchange(exchangeId, creatorId){
    await query(`INSERT IGNORE INTO exchange (
        exchangeId,
        creatorId,
        started,
        description) VALUES (
            ?, ?, 0,''
        )
    `, [exchangeId, creatorId]);
}